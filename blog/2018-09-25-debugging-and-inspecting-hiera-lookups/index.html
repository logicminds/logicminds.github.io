<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=../../css/fonts.css rel=stylesheet type=text/css><title>Debugging and Inspecting hiera lookups</title><link rel=stylesheet href=../../css/hugo-octopress.css><link rel=stylesheet href=../../css/fork-awesome.min.css><link href=../../favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Corey Osman"><meta name=generator content="Hugo 0.82.0"></head><body><header role=banner><hgroup><h1><a href=../../>Logical thoughts exposed</a></h1><h2>A journey through my life as a infrastructure developer</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option></select></fieldset><ul class=main-navigation></ul><ul class=subscription><a href=../../index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Sep 25, 2018
- 6 minute read
- <a href=../../blog/2018-09-25-debugging-and-inspecting-hiera-lookups/#disqus_thread>Comments</a>
- <a class=label href=../../categories/debugger/>debugger </a><a class=label href=../../categories/hiera/>hiera </a><a class=label href=../../categories/puppet/>puppet </a><a class=label href=../../categories/devops/>devops</a></p><h1 class=entry-title>Debugging and Inspecting hiera lookups</h1></header><div class=entry-content><p>Summary: In this article you will learn how to debug hiera lookups using the traditional methods and more importantly with the puppet-debugger which can cover a multitude of use cases.</p><p>Previously, debugging
<a href=https://puppet.com/docs/puppet/4.10/hiera_intro.html target=_blank rel=noopener>hiera</a> lookups has been limited to the command line and debug logs. If you wanted to debug hiera
lookups you had to use the hiera command and pass in the config file along with the scope (variables, facts) you wanted to use.</p><pre><code>$ hiera -d -c /etc/puppet/hiera.yaml key1 environment=production

DEBUG: 2017-10-20 13:10:48 -0700: Hiera YAML backend starting
DEBUG: 2017-10-20 13:10:48 -0700: Looking up key1 in YAML backend
DEBUG: 2017-10-20 13:10:48 -0700: Ignoring bad definition in :hierarchy: 'nodes/'
DEBUG: 2017-10-20 13:10:48 -0700: Looking for data source common
DEBUG: 2017-10-20 13:10:48 -0700: Cannot find datafile /etc/puppetlabs/code/environments/production/hieradata/common.yaml, skipping
nil
</code></pre><p>This was a good start in the puppet 3.x days, because we were new to hirea. However, hiera has become a huge part of module development
and is a backbone to putting data in your code. Thus debugging became super annoying with always having to pass in the scope or override variables.</p><p>Then came Puppet 4 which introduced hiera 3,4 and 5 along with many new capabilities. Furthermore, Puppet 4.7+ now integrates hiera into the same puppet gem.
This integration and new version provided much improved debugging capabilities. You now get way more output from the puppet
<a href=https://puppet.com/docs/puppet/5.3/man/lookup.html target=_blank rel=noopener>lookup command</a>.
In Puppet 5, Puppet took the old hiera command and renamed it to puppet lookup along with other refinements. This was great because it ships with puppet and is right there at your fingertips. More importantly it knows about your puppet
environment, so passing the scope and hiera config file is not necessary. The explain option is quite useful where there are complex hiera configurations. Using the puppet lookup &ndash;explain
command will help you solve many problems.</p><pre><code> ~/testmod $ puppet lookup key1 --explain
Searching for &quot;key1&quot;
  Global Data Provider (hiera configuration version 5)
    Using configuration &quot;/Users/user/github/puppet-debugger-demo/hieradata/hiera.yaml&quot;
    Hierarchy entry &quot;common&quot;
      Path &quot;/Users/user/github/puppet-debugger-demo/hieradata/data/common.yaml&quot;
        Original path: &quot;common.yaml&quot;
        Found key: &quot;key1&quot; value: &quot;hello&quot;
</code></pre><p>But what if your hiera config or hiera data requires even something more complex? So complex that lookup explain doesn&rsquo;t explain enough.</p><p>What if you want to know how hiera interpolation tokens work? How do control which scopes are passed in?</p><p>What if you want to play around with
<a href=https://docs.puppet.com/puppet/4.5/lookup_quick.html#setting-lookupoptions-in-data target=_blank rel=noopener>lookup options</a> and merge behavior?</p><p>What if you need to know why hiera is not returning the value you expected?</p><p>In order to answer these kinds of questions we need to use the puppet debugger. You might have previously thought that the
<a href=https://www.puppet-debugger.com target=_blank rel=noopener>puppet debugger</a> was just for puppet code.
But the puppet debugger can do so much more because how how the language interacts with all these other tools.</p><p>Puppet by design allows us to use puppet functions that are executed during the compilation process. Because the debugger is a interactive REPL we can
execute functions directly in real time. This functionality is similar to the puppet lookup command but also allows you see and play with the returned
data.</p><h2 id=steps-for-debugging-hiera-with-the-debugger>Steps for Debugging hiera with the debugger</h2><p>Perform the following steps from your puppet development system</p><ol><li>Install the debugger <code>gem install puppet-debugger</code></li><li>Setup your puppet configuration file for the global hiera tier
a. <code>mkdir -p $(puppet config print confdir)</code>
b. <code>touch $(puppet config print config)</code>
c. Add the hiera_config setting <code>puppet config set hiera_config /home/user1/repos/hieradata/hiera.yaml</code> (Your hiera config path will be different)</li><li>Make sure the hiera config file points to the data directory relative to the location of the hiera config file.</li><li>The example datadir I have is in the same directory as the hiera.yaml file, feel free to move it elsewhere.</li></ol><pre><code>.
├── data
│   ├── common.yaml
│   ├── datacenter
│   │   ├── datacenter1.yaml
│   │   └── datacenter2.yaml
│   ├── node
│   │   ├── foo.example.com.yaml
│   │   └── master.local.yaml
│   ├── operatingsystem
│   │   ├── RedHat.yaml
│   │   ├── centos.yaml
│   │   └── ubuntu.yaml
│   └── osfamily
│       └── Debian.yaml
├── hiera.yaml
├── hiera2.yaml
└── otherdata
    └── common.yaml

$ more hiera.yaml
---
version: 5
defaults:
  datadir: data
  data_hash: yaml_data
hierarchy:
    - name: &quot;common&quot;
      path: &quot;common.yaml&quot;
</code></pre><p>Note: you can swap out the hiera config by having multiple configs handy. So in this exmaple I can change from hiera.yaml to hiera2.yaml</p><p><code>puppet config set hiera_config /home/user1/repos/hieradata/hiera2.yaml</code></p><p>Additionally if you want to override the hiera config from the command line you can use</p><p><code>puppet debugger --hiera_config=/home/user1/repos/hieradata/hiera2.yaml</code></p><p><em>NOTE</em> the hiera_config is a
<a href=https://puppet.com/docs/puppet/5.5/configuration.html target=_blank rel=noopener>puppet config</a>, and there are many more configs you can swap out that will change the environment the debugger uses.</p><h3 id=start-debugging>Start debugging</h3><p>Once the debugger is setup you can start the debugger by running <code>puppet debugger</code></p><p>Then use the lookup function to lookup your key</p><pre><code>Ruby Version: 2.4.1
Puppet Version: 5.3.2
Puppet Debugger Version: 0.8.1
Created by: NWOps &lt;corey@nwops.io&gt;
Type &quot;commands&quot; for a list of debugger commands
or &quot;help&quot; to show the help screen.


1:&gt;&gt; lookup('key1')
 =&gt; &quot;hello&quot;
2:&gt;&gt;
</code></pre><p>Not very helpful by itself as you only get the value. But the scope was injected for you by the debugger. This
means that the hiera.yaml file interpolates the facts and variables you set in the debugger.</p><h3 id=more-output>More output</h3><p>Turn up the loglevel to &ldquo;debug&rdquo; to get the output normally provided with <code>puppet lookup --explain</code></p><pre><code>Ruby Version: 2.4.1
Puppet Version: 5.3.2
Puppet Debugger Version: 0.8.1
Created by: NWOps &lt;corey@nwops.io&gt;
Type &quot;commands&quot; for a list of debugger commands
or &quot;help&quot; to show the help screen.

1:&gt;&gt; set loglevel debug
loglevel debug is set
1:&gt;&gt; lookup('key1')
  Searching for &quot;key1&quot;
    Global Data Provider (hiera configuration version 5)
      Using configuration &quot;/Users/user1/github/puppet-debugger-demo/hieradata/hiera.yaml&quot;
      Hierarchy entry &quot;common&quot;
        Path &quot;/Users/user1/github/puppet-debugger-demo/hieradata/data/common.yaml&quot;
          Original path: &quot;common.yaml&quot;
          Found key: &quot;key1&quot; value: &quot;hello&quot;
 =&gt; &quot;hello&quot;
2:&gt;&gt;

</code></pre><p>This log level provides a more detailed lookup process and can help identify faulty keys and values.</p><h2 id=but-wait--there-is-even-more-debugging-to-be-had>But Wait! There is even more debugging to be had</h2><p>We know from above that we can lookup the key. And we can also see how the value of that key is derived with the debug log level. But how do
we know the value of that key is the same datatype that puppet is expecting.</p><p>You can
<a href=../../posts/testing_datatypes/>compare the datatype</a> returned with the expected datatype with the <code>=~</code> operator.</p><pre><code>1:&gt;&gt; lookup('key1')
 =&gt; &quot;hello&quot;
2:&gt;&gt; lookup('key1') =~ String
 =&gt; true
3:&gt;&gt;

</code></pre><p>Or something more complex</p><pre><code>10:&gt;&gt; lookup('foo_complex3') =~ Array[Hash]
 =&gt; true
11:&gt;&gt;
</code></pre><p>Or even store the returned value in a variable and have a look</p><pre><code>11:&gt;&gt; $complex_value = lookup('foo_complex3')
12:&gt;&gt; $complex_value[0]
 =&gt; {
  &quot;key1&quot; =&gt; [
    [0] {
      &quot;name&quot; =&gt; &quot;value1&quot;
    },
    [1] {
      &quot;name&quot; =&gt; &quot;value2&quot;
    },
    [2] {
      &quot;name&quot; =&gt; &quot;value3&quot;
    }
  ]
}
</code></pre><p>The debugger allows you to get into the nitty gritty details of the variable returned from hiera. Additionally,
you get to mess around and transform the variable contents with looping iterators like map/reduce/dig. You don&rsquo;t have this ability
when using the <code>explain</code> method, simply because the debugger is the only way to interact with puppet code.</p><p>So start debugging your code and hiera lookups with the debugger and demystify the lookup process.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Corey Osman</span></span>
<time>Sep 25, 2018</time></span></p><p class=meta><a class="basic-alignment left" href=../../blog/2017-10-12-retrospec-the-task-generator/ title="Retrospec - the task generator">Retrospec - the task generator</a>
<a class="basic-alignment right" href=../../blog/2018-09-25-alternative-facts/ title="Alternative Facts">Alternative Facts</a></p><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//logicalthoughtsexposed.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nwops/ title=https://github.com/nwops/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cosman2001 title=https://twitter.com/cosman2001><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/logicmindscorp/ title=https://www.linkedin.com/in/logicmindscorp/><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><li><a href=../../categories/ title=Categories>Categories</a></li><li><a href=../../tags/ title=Tags>Tags</a></li></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=../../blog/2021-04-14-decouple-your-control-repo-branches/>Decouple Your Control Repo Branches</a></li><li class=post><a href=../../blog/2021-02-15-no-code-is-the-best-code/>No Code Is the Best Code</a></li><li class=post><a href=../../blog/2021-02-14-getting-real-with-the-ral/>Getting real with the RAL</a></li><li class=post><a href=../../blog/2019-04-02-adding-puppet-debugger-and-other-gems-when-using-pdk/>Adding Puppet Debugger and other gems when using PDK</a></li><li class=post><a href=../../blog/2018-09-25-alternative-facts/>Alternative Facts</a></li><li class=post><a href=../../blog/2018-09-25-debugging-and-inspecting-hiera-lookups/>Debugging and Inspecting hiera lookups</a></li><li class=post><a href=../../blog/2017-10-12-retrospec-the-task-generator/>Retrospec - the task generator</a></li><li class=post><a href=../../blog/2017-06-01-put-some-data-in-your-module/>Put some data in your module</a></li><li class=post><a href=../../blog/2017-04-25-break-into-your-puppet-code/>Break into your puppet code</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2021 Corey Osman - <a href=../../license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>