<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link href=../../css/fonts.css rel=stylesheet type=text/css>
<title>How to build a module schema</title>
<link rel=stylesheet href=../../css/hugo-octopress.css>
<link rel=stylesheet href=../../css/fork-awesome.min.css>
<link href=../../favicon.png rel=icon>
<meta name=description content>
<meta name=keywords content>
<meta name=author content="Corey Osman">
<meta name=generator content="Hugo 0.92.2">
</head>
<body>
<header role=banner>
<hgroup>
<h1><a href=../../>Logical thoughts exposed</a></h1>
<h2>A journey through my life as a infrastructure developer</h2>
</hgroup></header>
<nav role=navigation>
<fieldset class=mobile-nav>
<select onchange="location=this.value"><option value>Navigateâ€¦</option></select>
</fieldset>
<ul class=main-navigation>
</ul>
<ul class=subscription>
<a href=../../index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
</ul>
<form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer">
<fieldset role=search>
<input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:/>
</fieldset>
</form>
</nav>
<div id=main>
<div id=content>
<div>
<article class=hentry role=article>
<header>
<p class=meta>Jan 15, 2016
- 5 minute read
- <a href=../../blog/2016-01-15-how-to-build-a-module-schema/#disqus_thread>Comments</a>
- <a class=label href=../../categories/puppet/>puppet </a><a class=label href=../../categories/testing/>testing </a><a class=label href=../../categories/validation/>validation </a>
</p>
<h1 class=entry-title>
How to build a module schema
</h1>
</header>
<div class=entry-content>
<p>As a long time puppet module developer and puppet consultant I have noticed some trends over the years. Puppet modules are becoming increasingly sophisticated and complex. When consuming forge modules I often spend time figuring out how it works and what the developer requires for parameters. Especially when it comes to inserting data into hiera.</p>
<p>Schemas help validate the user is doing what the developer intended.</p>
<p>Creating a schema might not seem necessary but anybody using your module will greatly appreciate it. So if your a module developer here is how you can create a schema.</p>
<h2 id=install-kwalify>Install Kwalify</h2>
<p>Kwalfy is a project that allows you to easily write a schema and parse the yaml file against the schema you created.</p>
<p>To install: <code>gem install kwalify</code></p>
<h2 id=create-a-schema-yaml-file>Create a Schema Yaml file</h2>
<p>The schema details all the inputs for your module and there are a two ways to create one. Manual or Automatic. If doing manually head over to the
<a href=http://www.kuwata-lab.com/kwalify/ruby/users-guide.01.html#schema target=_blank rel=noopener>kwalify</a> docs to see what options you can specify. For automatic generation use the
<a href=https://github.com/nwops/puppet-retrospec target=_blank rel=noopener>retrospec puppet tool</a> to auto generate a schema. But retrospec doesn&rsquo;t do enough. The schema definition does not accurately reflect parameter types because puppet is a loosely typed language, so even retrospec cannot determine with the resource exactly needs. So you will need to further define your schema if you have complex data. However, retrospec will get you started and you can update the schema as needed.</p>
<p>The module schema should be named modulename_schema.yaml and placed in the root of your module.</p>
<pre tabindex=0><code>cd /Users/user1/github/puppetlabs-apache
retrospec puppet
+ /Users/user1/github/puppetlabs-apache/puppetlabs-apache_schema.yaml
</code></pre><h2 id=map-your-parameters>Map Your parameters</h2>
<p>Your schema file should detail exactly what your puppet class or definition is
expecting. Be extremely detailed. Your users will love you.</p>
<h3 id=simple-example>Simple example</h3>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
  <span style=color:#268bd2>type</span>: map
  <span style=color:#268bd2>mapping</span>:
    <span style=color:#268bd2>hostclass</span>:
      <span style=color:#268bd2>type</span>: map
      <span style=color:#268bd2>mapping</span>:
        <span style=color:#2aa198>&#34;tomcat::catalina_home&#34;</span>:
          <span style=color:#268bd2>type</span>: str
          <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>false</span>
        <span style=color:#2aa198>&#34;tomcat::user&#34;</span>:
          <span style=color:#268bd2>type</span>: str
          <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>false</span>
</code></pre></div><h3 id=complex-example>Complex Example</h3>
<p>Example of a more detailed schema, this is an example using the puppet lvm module.
Not everyone will have a complex schema, but some of us will.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#268bd2>type</span>: map
<span style=color:#268bd2>mapping</span>:
  <span style=color:#268bd2>hostclass</span>:
    <span style=color:#268bd2>type</span>: map
    <span style=color:#268bd2>mapping</span>:
      <span style=color:#2aa198>&#34;lvm::volume_groups&#34;</span>:
        <span style=color:#268bd2>type</span>: map
        <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>false</span>
        <span style=color:#268bd2>mapping</span>:
          <span style=color:#268bd2>=</span>:
            <span style=color:#268bd2>type</span>: map
            <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>true</span>
            <span style=color:#268bd2>mapping</span>:
              <span style=color:#268bd2>&#39;physical_volumes&#39;</span>:
                <span style=color:#268bd2>type</span>: seq
                <span style=color:#268bd2>desc</span>: <span style=color:#2aa198>&#39;A list of physical volumes to use for the volume group&#39;</span>
                <span style=color:#268bd2>sequence</span>:
                  - <span style=color:#268bd2>type</span>: str
                <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>true</span>
              <span style=color:#268bd2>&#39;logical_volumes&#39;</span>:
                <span style=color:#268bd2>type</span>: map
                <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>true</span>
                <span style=color:#268bd2>mapping</span>:
                  <span style=color:#268bd2>=</span>:
                    <span style=color:#268bd2>type</span>: map
                    <span style=color:#268bd2>desc</span>: <span style=color:#2aa198>&#39;The logical volume name&#39;</span>
                    <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>true</span>
                    <span style=color:#268bd2>mapping</span>:
                      <span style=color:#268bd2>&#39;size&#39;</span>:
                        <span style=color:#268bd2>type</span>: str
                        <span style=color:#268bd2>pattern</span>: /[1-9]\d?[kKmMgGtT]{1}/
                        <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>true</span>
                        <span style=color:#268bd2>desc</span>: <span style=color:#2aa198>&#39;The size of the logical volume&#39;</span>
                      <span style=color:#268bd2>&#39;mountpath&#39;</span>:
                        <span style=color:#268bd2>type</span>: str
                        <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>true</span>
                        <span style=color:#268bd2>desc</span>: <span style=color:#2aa198>&#34;Where to mount the logical volume&#34;</span>
                      <span style=color:#268bd2>&#39;fs_type&#39;</span>:
                        <span style=color:#268bd2>default</span>: ext4
                        <span style=color:#268bd2>desc</span>: <span style=color:#2aa198>&#34;The filesystem type to use when formating. &#34;</span>
                        <span style=color:#268bd2>type</span>: str
                        <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>false</span>
                        <span style=color:#268bd2>enum</span>: [<span style=color:#2aa198>&#39;swap&#39;</span>, <span style=color:#2aa198>&#39;ext4&#39;</span>, <span style=color:#2aa198>&#39;ext3&#39;</span>]

</code></pre></div><h3 id=use-a-data-type>Use a data type</h3>
<p>Just like in puppet 4 kwalify allows the use of data types. I suspect str, any,
bool, number, map, and seq will be the most used.
Below are all the types we can use in our schema:</p>
<ul>
<li>str</li>
<li>int</li>
</ul>
<ul>
<li>float</li>
<li>number (== int or float)</li>
<li>text (== str or number)</li>
<li>bool</li>
<li>date</li>
<li>time</li>
<li>timestamp</li>
<li>seq</li>
<li>map</li>
<li>scalar (all but seq and map)</li>
<li>any (means any data)</li>
</ul>
<h3 id=use-a-constraint>Use a constraint</h3>
<p>You can require and item, and require a specific type, and you can also require
the value to a specific set. This is very similar to puppet 4 data types.</p>
<ul>
<li>regex patterns</li>
<li>enums</li>
<li>ranges</li>
<li>length</li>
</ul>
<h3 id=document-the-default-values-and-description>Document the default values and description</h3>
<p>Now this might seem redundant because you already documented these in puppet.<br>
But if the schema contains the description and default values, the user only has
to view a single file instead of many files. Furthermore, with proper tooling
we should be able to either pull this data out of puppet or use the schema to
populate the puppet code with default values and comments that are defined in the schema.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>&#39;fs_type&#39;</span>:
  <span style=color:#268bd2>default</span>: ext4
  <span style=color:#268bd2>desc</span>: <span style=color:#2aa198>&#34;The filesystem type to use when formating. &#34;</span>
  <span style=color:#268bd2>type</span>: str
  <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>false</span>
  <span style=color:#268bd2>enum</span>: [<span style=color:#2aa198>&#39;swap&#39;</span>, <span style=color:#2aa198>&#39;ext4&#39;</span>, <span style=color:#2aa198>&#39;ext3&#39;</span>]
</code></pre></div><p>See
<a href=http://www.kuwata-lab.com/kwalify/ruby/users-guide.01.html#schema target=_blank rel=noopener>Rules and Constraints</a> for more info.</p>
<h3 id=make-items-required>Make items required</h3>
<p>You can require parameters if your puppet code doesn&rsquo;t supply a default.
If the user doesn&rsquo;t supply the fs_type, validation will fail.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>&#39;fs_type&#39;</span>:
  <span style=color:#268bd2>type</span>: str
  <span style=color:#268bd2>required</span>: <span style=color:#cb4b16>true</span>
  <span style=color:#268bd2>enum</span>: [<span style=color:#2aa198>&#39;swap&#39;</span>, <span style=color:#2aa198>&#39;ext4&#39;</span>, <span style=color:#2aa198>&#39;ext3&#39;</span>]
</code></pre></div><h2 id=validate-your-schema-with-kwalify>Validate Your schema with Kwalify</h2>
<p>To ensure your schema is a valid schema use the following command. This simply
validates your schema against the kwalify tool.</p>
<p><code>kwalify -m your_schema.yaml</code></p>
<h2 id=create-a-sample-data-set-for-testing-purposes>Create a sample data set for testing purposes</h2>
<p>Below is an example of data set that would be used with the puppet lvm module.
This would most likely be in hiera.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#268bd2>hostclass</span>:
  <span style=color:#268bd2>lvm::volume_groups</span>:
    <span style=color:#268bd2>vg00</span>:
      <span style=color:#268bd2>physical_volumes</span>:
        - /dev/sda2
        - /dev/sdd
        - /dev/sdc
      <span style=color:#268bd2>logical_volumes</span>:
        <span style=color:#268bd2>audit</span>:
          <span style=color:#268bd2>size</span>: 160M
          <span style=color:#268bd2>mountpath</span>: /var/audit
        <span style=color:#268bd2>lv04</span>:
          <span style=color:#268bd2>size</span>: 4G
          <span style=color:#268bd2>mountpath</span>: /tmp
        <span style=color:#268bd2>lv_swap</span>:
          <span style=color:#268bd2>size</span>: 0G
          <span style=color:#268bd2>fs_type</span>: swapp
          <span style=color:#268bd2>mountpath</span>: swap
    <span style=color:#268bd2>vg01</span>:
      <span style=color:#268bd2>physical_volumes</span>:
        - /dev/sdb
      <span style=color:#268bd2>logical_volumes</span>:
        <span style=color:#268bd2>lv01</span>:
          <span style=color:#268bd2>size</span>: 32M
          <span style=color:#268bd2>mountpath</span>: /system/app
        <span style=color:#268bd2>lv02</span>:
          <span style=color:#268bd2>size</span>: 16M
          <span style=color:#268bd2>mountpath</span>: /system/oracle
        <span style=color:#268bd2>lv03</span>:
          <span style=color:#268bd2>size</span>: 40M
          <span style=color:#268bd2>mountpath</span>: /var/opt/oracle
        <span style=color:#268bd2>backup</span>:
          <span style=color:#268bd2>size</span>: 0K
          <span style=color:#268bd2>mountpath</span>: /backup
</code></pre></div><h2 id=validate-your-data-against-your-schema>Validate your data against your schema</h2>
<p>Now we will validate the data against our schema. Notice that my sample data set contains a few errors. Did you even notice?
This is intentional, because this shit won&rsquo;t work if you accidentally had these values in hiera. Because that would never happen &mldr;</p>
<pre tabindex=0><code>kwalify -lf test_schema.yaml /tmp/test_schema_data.yaml
/tmp/test_schema_data.yaml#0: INVALID
- (line 16) [/hostclass/lvm::volume_groups/vg00/logical_volumes/lv_swap/size] '0G': not matched to pattern /[1-9]\d?[kKmMgGtT]{1}/.
- (line 17) [/hostclass/lvm::volume_groups/vg00/logical_volumes/lv_swap/fs_type] 'swapp': invalid fs_type value.
- (line 33) [/hostclass/lvm::volume_groups/vg01/logical_volumes/backup/size] '0K': not matched to pattern /[1-9]\d?[kKmMgGtT]{1}/.
</code></pre><p>Now the cool about this type of validation is that it is immediate and extremely specific.
If every module developer had a well defined schema, there would be no errors in our hiera data.</p>
<h2 id=summary>Summary</h2>
<p>There is still lots to learn but the process for creating a schema is the same across every module. So hopefully this article is enough to get you started. Having a schema for your module allows the end user to easily assemble a master schema in order to validate all of their hiera data. It could also be used to create a README file that details all the parameters as well. I suspect that if schema files take off we can see some further tooling around generation and possibly more use cases for schemas.</p>
<p>So stay tuned as my next article talks about just how to
<a href=http://logicminds.github.io/blog/2016/01/16/testing-hiera-data target=_blank rel=noopener>validate hiera</a> using schemas.</p>
</div>
<footer>
<p class=meta>
<span class="byline author vcard">Posted by <span class=fn>Corey Osman</span></span>
<time>Jan 15, 2016</time>
</span>
</p>
<p class=meta>
<a class="basic-alignment left" href=../../blog/2015-05-28-leveraging-docker-for-puppet-development/ title="Leveraging Docker for Puppet Development">Leveraging Docker for Puppet Development</a>
<a class="basic-alignment right" href=../../blog/2016-01-16-testing-hiera-data/ title="Testing Hiera Data">Testing Hiera Data</a>
</p>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//logicalthoughtsexposed.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</footer>
</article>
</div>
<aside class="sidebar thirds">
<section class="first odd">
<p>
</p>
</section>
<ul class=sidebar-nav>
<li class=sidebar-nav-item>
<a target=_blank rel="noopener noreferrer" href=https://github.com/nwops/ title=https://github.com/nwops/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cosman2001 title=https://twitter.com/cosman2001><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/logicmindscorp/ title=https://www.linkedin.com/in/logicmindscorp/><i class="fa fa-linkedin fa-3x"></i></a>
</li>
</ul>
<section class=odd>
<li>
<a href=../../categories/ title=Categories>Categories</a>
</li>
<li>
<a href=../../tags/ title=Tags>Tags</a>
</li>
</section>
<section class=even>
<h1>Recent Posts</h1>
<ul id=recent_posts>
<li class=post>
<a href=../../blog/2021-04-14-decouple-your-control-repo-branches/>Decouple Your Control Repo Branches</a>
</li>
<li class=post>
<a href=../../blog/2021-02-15-no-code-is-the-best-code/>No Code Is the Best Code</a>
</li>
<li class=post>
<a href=../../blog/2021-02-14-getting-real-with-the-ral/>Getting real with the RAL</a>
</li>
<li class=post>
<a href=../../blog/2019-04-02-adding-puppet-debugger-and-other-gems-when-using-pdk/>Adding Puppet Debugger and other gems when using PDK</a>
</li>
<li class=post>
<a href=../../blog/2018-09-25-alternative-facts/>Alternative Facts</a>
</li>
<li class=post>
<a href=../../blog/2018-09-25-debugging-and-inspecting-hiera-lookups/>Debugging and Inspecting hiera lookups</a>
</li>
<li class=post>
<a href=../../blog/2017-10-12-retrospec-the-task-generator/>Retrospec - the task generator</a>
</li>
<li class=post>
<a href=../../blog/2017-06-01-put-some-data-in-your-module/>Put some data in your module</a>
</li>
<li class=post>
<a href=../../blog/2017-04-25-break-into-your-puppet-code/>Break into your puppet code</a>
</li>
</ul>
</section>
</aside>
</div>
</div>
<footer role=contentinfo>
<p>Copyright &copy; 2022 Corey Osman - <a href=../../license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.
</p>
</footer>
</body>
</html>