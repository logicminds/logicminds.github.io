<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=../../css/fonts.css rel=stylesheet type=text/css><title>Testing DataTypes with the Puppet Debugger</title><link rel=stylesheet href=../../css/hugo-octopress.css><link rel=stylesheet href=../../css/fork-awesome.min.css><link href=../../favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Corey Osman"><meta name=generator content="Hugo 0.82.0"></head><body><header role=banner><hgroup><h1><a href=../../>Logical thoughts exposed</a></h1><h2>A journey through my life as a infrastructure developer</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigateâ€¦</option></select></fieldset><ul class=main-navigation></ul><ul class=subscription><a href=../../index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Mar 25, 2017
- 4 minute read
- <a href=../../blog/2017-03-25-testing-datatypes-with-the-puppet-debugger/#disqus_thread>Comments</a>
- <a class=label href=../../categories/devops/>devops </a><a class=label href=../../categories/puppet/>puppet </a><a class=label href=../../categories/testing/>testing </a><a class=label href=../../categories/debugger/>debugger</a></p><h1 class=entry-title>Testing DataTypes with the Puppet Debugger</h1></header><div class=entry-content><p>The puppet language comes with a lot of extremely useful syntax and concepts. However, sometimes it is difficult to understand
how these work or how to use them. Datatypes are found in almost every programming language so it is no surprise that puppet 4 has a similar feature for validating parameter data. If you have never used a puppet datatype before have a look
<a href=https://docs.puppet.com/puppet/4.9/lang_data_type.html target=_blank rel=noopener>here</a> first.</p><p>The other day I was showing my client the awesome power of puppet datatypes and I was using the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> to illustrate how datatypes work. By using the puppet debugger the client was immediately able to understand datatypes without writing a manifest, so I wanted to share how to use datatypes using the debugger to the rest of the world because datatypes can be very complex and using the debugger will help you understand how they work.</p><p>Let us first detail how to use a datatype with puppet parameters.</p><h2 id=using-a-datatype>Using a datatype</h2><p>Below is a snippet of a puppet defined type that has no datatype validations. Obviously the result of running this code would fail.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>define foo(
  $bar <span style=color:#719e07>=</span> <span style=color:#2aa198>&#39;barbar&#39;</span>
  ) {
    file{<span style=color:#2aa198>&#39;/tmp/test&#39;</span>:
      <span style=color:#719e07>ensure</span> <span style=color:#719e07>=&gt;</span> $bar,
    }
  }
  foo{<span style=color:#2aa198>&#39;test&#39;</span>: bar <span style=color:#719e07>=&gt;</span> <span style=color:#719e07>[</span><span style=color:#2aa198>1</span>,<span style=color:#2aa198>2</span>,<span style=color:#2aa198>3</span><span style=color:#719e07>]</span>}
</code></pre></div><p>So to prevent an error, we should be checking the value of <code>bar</code> in the parameter. Previously you might have used <code>validate_string($bar)</code> which was a function from the
<a href=https://github.com/puppetlabs/puppetlabs-stdlib target=_blank rel=noopener>stdlib</a> module that performed validations. This validation would occur only when the catalog is applied to a system. But that is way too late, we need to fail faster. So if you want an error to popup well before you deploy the code you need to inform Puppet that you expect a certain type of data. Hence the word &lsquo;datatype&rsquo;.</p><p>Adding a datatype would cause the compilation to fail immediately at compile time which you can check by writing a unit test or running puppet apply.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>define foo(
  <span style=color:#cb4b16>Enum</span><span style=color:#719e07>[</span><span style=color:#2aa198>&#39;directory&#39;</span>, <span style=color:#2aa198>&#39;present&#39;</span>, <span style=color:#2aa198>&#39;file&#39;</span><span style=color:#719e07>]</span> $bar,
  ) {
    file{<span style=color:#2aa198>&#39;/tmp/test&#39;</span>:
      <span style=color:#719e07>ensure</span> <span style=color:#719e07>=&gt;</span> $bar,
    }
  }
  foo{<span style=color:#2aa198>&#39;test&#39;</span>: bar <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;present&#39;</span> }
</code></pre></div><p>However, if you are not ready to jump into unit testing, you can utilize the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> to bridge the gap.
Using the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> is the easiest, fastest way to validate that the parameter datatype accurately reflects the type of data your manifest requires.</p><h2 id=installing-the-puppet-debugger>Installing the Puppet Debugger</h2><p>To get started you need to install the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> on any system with puppet >= 3.8</p><p><code>gem install puppet-debugger</code></p><h3 id=testing-a-datatype-with-the-debugger>Testing a DataType with the Debugger</h3><p>In order to test the data against the datatype we are going to use the <code>=~</code> operator. This operator lets us test out the datatype.
The data being tested goes on the LHS (left hand side) while the datatype goes on the RHS (right hand side).</p><p>Examples:</p><ol><li><code>true =~ Boolean</code></li><li><code>'true' =~ String</code></li><li><code>'https://www.google.com' =~ Stdlib::HttpsUrl</code></li></ol><p>{% img [class names] /images/datatypes.gif &lsquo;Puppet Datatypes Demo&rsquo; &lsquo;Puppet Datatypes Demo&rsquo; %}</p><p>If the value on the LHS matches the requirements on the RHS, puppet will return true, other false is returned and the
value does not match the datatype.</p><h3 id=testing-a-datatype-with-the-debugger-using-the-new-function>Testing a DataType with the Debugger using the new function</h3><p>Another way to test your datatype is use the [new operator](<a href=https://docs.puppet.com/puppet/latest/function.html#new_>https://docs.puppet.com/puppet/latest/function.html#new_</a>. This only works with some datatypes like structures and core types.
But if you have a complex datatype like a structure you can use the new operator to test out the custom datatype. In this example puppet shows an error because
we did not specify an owner attribute on line 11.</p><p><a href=https://docs.puppet.com/puppet/4.9/lang_data_abstract.html target=_blank rel=noopener>More Info about Abstract Data Types</a></p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#2aa198>1</span><span style=color:#2aa198>:&gt;&gt;</span> type <span style=color:#cb4b16>MyType</span> <span style=color:#719e07>=</span> <span style=color:#cb4b16>Struct</span><span style=color:#719e07>[</span>{
  <span style=color:#2aa198>2</span><span style=color:#2aa198>:&gt;&gt;</span>         mode <span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Enum</span><span style=color:#719e07>[</span>read, write, update<span style=color:#719e07>]</span>,
  <span style=color:#2aa198>3</span><span style=color:#2aa198>:&gt;&gt;</span>         path            <span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Optional</span><span style=color:#719e07>[</span><span style=color:#b58900>String</span><span style=color:#719e07>[</span><span style=color:#2aa198>1</span><span style=color:#719e07>]]</span>,
  <span style=color:#2aa198>4</span><span style=color:#2aa198>:&gt;&gt;</span>         <span style=color:#cb4b16>NotUndef</span><span style=color:#719e07>[</span>owner<span style=color:#719e07>]</span> <span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Optional</span><span style=color:#719e07>[</span><span style=color:#b58900>String</span><span style=color:#719e07>[</span><span style=color:#2aa198>1</span><span style=color:#719e07>]]</span>}<span style=color:#719e07>]</span>
<span style=color:#2aa198>5</span><span style=color:#2aa198>:&gt;&gt;</span> <span style=color:#cb4b16>MyType</span><span style=color:#719e07>.</span>new({
  <span style=color:#2aa198>6</span><span style=color:#2aa198>:&gt;&gt;</span> mode <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;read&#39;</span>,
  <span style=color:#2aa198>7</span><span style=color:#2aa198>:&gt;&gt;</span> path <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/dev/null&#39;</span>,
  <span style=color:#2aa198>8</span><span style=color:#2aa198>:&gt;&gt;</span> owner <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;root&#39;</span>
  <span style=color:#2aa198>9</span><span style=color:#2aa198>:&gt;&gt;</span> }
  <span style=color:#2aa198>10</span><span style=color:#2aa198>:&gt;&gt;</span> )
 <span style=color:#719e07>=&gt;</span> {
   <span style=color:#2aa198>&#34;mode&#34;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;read&#34;</span>,
  <span style=color:#2aa198>&#34;owner&#34;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;root&#34;</span>,
   <span style=color:#2aa198>&#34;path&#34;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;/dev/null&#34;</span>
}
<span style=color:#2aa198>11</span><span style=color:#2aa198>:&gt;&gt;</span> <span style=color:#cb4b16>MyType</span><span style=color:#719e07>.</span>new({mode <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;read&#39;</span>})
 <span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Evaluation</span> <span style=color:#2aa198>Error</span>: <span style=color:#cb4b16>Error</span> <span style=color:#719e07>while</span> evaluating a <span style=color:#cb4b16>Method</span> call, <span style=color:#cb4b16>Converted</span> value from <span style=color:#cb4b16>MyType</span> <span style=color:#719e07>=</span> <span style=color:#cb4b16>Struct</span><span style=color:#719e07>[</span>{<span style=color:#2aa198>&#39;mode&#39;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Enum</span><span style=color:#719e07>[</span><span style=color:#2aa198>&#39;read&#39;</span>, <span style=color:#2aa198>&#39;update&#39;</span>, <span style=color:#2aa198>&#39;write&#39;</span><span style=color:#719e07>]</span>, <span style=color:#2aa198>&#39;path&#39;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Optional</span><span style=color:#719e07>[</span><span style=color:#b58900>String</span><span style=color:#719e07>[</span><span style=color:#2aa198>1</span>, default<span style=color:#719e07>]]</span>, <span style=color:#cb4b16>NotUndef</span><span style=color:#719e07>[</span><span style=color:#2aa198>&#39;owner&#39;</span><span style=color:#719e07>]</span> <span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Optional</span><span style=color:#719e07>[</span><span style=color:#b58900>String</span><span style=color:#719e07>[</span><span style=color:#2aa198>1</span>, default<span style=color:#719e07>]]</span>}<span style=color:#719e07>].</span>new() has wrong type, expects a value <span style=color:#719e07>for</span> key <span style=color:#2aa198>&#39;owner&#39;</span> at <span style=color:#dc322f>/var/</span>folders<span style=color:#719e07>/</span>v0<span style=color:#719e07>/</span>nzsrqr_n40d4v396b2bqjvdw0000gp<span style=color:#719e07>/</span>T<span style=color:#719e07>/</span>puppet_debugger_input20170424<span style=color:#719e07>-</span><span style=color:#2aa198>91861</span><span style=color:#719e07>-</span><span style=color:#2aa198>6</span>grwv7<span style=color:#719e07>.</span>pp:<span style=color:#2aa198>1</span>:<span style=color:#2aa198>11</span>
<span style=color:#2aa198>12</span><span style=color:#2aa198>:&gt;&gt;</span>
</code></pre></div><p>As you can see above the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> makes it dead simple to test datatypes. For repeatable datatype testing you will want to write unit tests instead which is not covered in this article. Additionally, the
<a href=https://github.com/puppetlabs/puppetlabs-stdlib#data-types target=_blank rel=noopener>stdlib</a> module also has some nice datatypes that you can use in your modules.</p><p>I hope this has been of value to you, please share with others and star the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> project if you enjoy using it.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Corey Osman</span></span>
<time>Mar 25, 2017</time></span></p><p class=meta><a class="basic-alignment left" href=../../blog/2016-01-16-testing-hiera-data/ title="Testing Hiera Data">Testing Hiera Data</a>
<a class="basic-alignment right" href=../../blog/2017-04-24-benchmarking-your-puppet-code/ title="Benchmarking Your Puppet Code">Benchmarking Your Puppet Code</a></p><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//logicalthoughtsexposed.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nwops/ title=https://github.com/nwops/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cosman2001 title=https://twitter.com/cosman2001><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/logicmindscorp/ title=https://www.linkedin.com/in/logicmindscorp/><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><li><a href=../../categories/ title=Categories>Categories</a></li><li><a href=../../tags/ title=Tags>Tags</a></li></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=../../blog/2021-03-13-decouple-your-control-repo-branches/>Decouple Your Control Repo Branches</a></li><li class=post><a href=../../blog/2021-02-15-no-code-is-the-best-code/>No Code Is the Best Code</a></li><li class=post><a href=../../blog/2021-02-14-getting-real-with-the-ral/>Getting real with the RAL</a></li><li class=post><a href=../../blog/2019-04-02-adding-puppet-debugger-and-other-gems-when-using-pdk/>Adding Puppet Debugger and other gems when using PDK</a></li><li class=post><a href=../../blog/2018-09-25-alternative-facts/>Alternative Facts</a></li><li class=post><a href=../../blog/2018-09-25-debugging-and-inspecting-hiera-lookups/>Debugging and Inspecting hiera lookups</a></li><li class=post><a href=../../blog/2017-10-12-retrospec-the-task-generator/>Retrospec - the task generator</a></li><li class=post><a href=../../blog/2017-06-01-put-some-data-in-your-module/>Put some data in your module</a></li><li class=post><a href=../../blog/2017-04-25-break-into-your-puppet-code/>Break into your puppet code</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2021 Corey Osman - <a href=../../license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>