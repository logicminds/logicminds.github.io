<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1">
<link href=../../css/fonts.css rel=stylesheet type=text/css>
<title>Break into your puppet code</title>
<link rel=stylesheet href=../../css/hugo-octopress.css>
<link rel=stylesheet href=../../css/fork-awesome.min.css>
<link href=../../favicon.png rel=icon>
<meta name=description content>
<meta name=keywords content>
<meta name=author content="Corey Osman">
<meta name=generator content="Hugo 0.92.2">
</head>
<body>
<header role=banner>
<hgroup>
<h1><a href=../../>Logical thoughts exposed</a></h1>
<h2>A journey through my life as a infrastructure developer</h2>
</hgroup></header>
<nav role=navigation>
<fieldset class=mobile-nav>
<select onchange="location=this.value"><option value>Navigateâ€¦</option></select>
</fieldset>
<ul class=main-navigation>
</ul>
<ul class=subscription>
<a href=../../index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a>
</ul>
<form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer">
<fieldset role=search>
<input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:/>
</fieldset>
</form>
</nav>
<div id=main>
<div id=content>
<div>
<article class=hentry role=article>
<header>
<p class=meta>Apr 25, 2017
- 4 minute read
- <a href=../../blog/2017-04-25-break-into-your-puppet-code/#disqus_thread>Comments</a>
- <a class=label href=../../categories/devops/>devops </a><a class=label href=../../categories/puppet/>puppet </a><a class=label href=../../categories/testing/>testing </a><a class=label href=../../categories/debugger/>debugger </a><a class=label href=../../categories/breakpoint/>breakpoint </a>
</p>
<h1 class=entry-title>
Break into your puppet code
</h1>
</header>
<div class=entry-content>
<p>The puppet 4 language introduced a slew of new features that gives us enormous amounts of power and flexibility. So much so that
puppet code can become complex and often hard to understand at a glance.</p>
<p>A way to combat this complexity is to write unit tests to validate the end state. However, one of the shortcomings of unit testing with rspec-puppet is that you can only test against the end state. Because puppet
is a &ldquo;compiled&rdquo; language there is not a good way to perform testing on intermediary states like the value of variables.</p>
<p>With this in mind, we need a way to get inside the puppet compiler and see how our code works from a logical standpoint instead of
just a static end state. The
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> is a tool that allows us to discover and explore the inner workings of puppet code in real time
as if you are standing inside the compiler with a big poking stick.</p>
<p><img src=../../images/aemzh.jpg alt="Poke Harder"></p>
<p>Below I will show you the steps needed to combine
<a href=http://rspec-puppet.com/ target=_blank rel=noopener>rspec-puppet</a> and the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a> to step into your code during compilation
time. So bring a stick because there will be many opportunities to poke things.</p>
<h2 id=requirements>Requirements</h2>
<p>In order to use the puppet-debugger please follow the steps below.</p>
<h3 id=install-puppet-debugger-gem>Install puppet-debugger gem</h3>
<p>Ensure you have installed the puppet-debugger gem</p>
<p><code>gem install puppet-debugger</code></p>
<p>or</p>
<p>Add it to your Gemfile</p>
<p><code>gem 'puppet-debugger', '>= 0.6'</code></p>
<h3 id=add-the-nwops-debughttpsforgepuppetcomnwopsdebug-puppet-module>Add the
<a href=https://forge.puppet.com/nwops/debug target=_blank rel=noopener>nwops-debug</a> puppet module</h3>
<p>You will also want to include
<a href=https://forge.puppet.com/nwops/debug target=_blank rel=noopener>this</a> module in your .fixtures.yml file if using rspec-puppet.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#2aa198>debug</span>:
   <span style=color:#2aa198>repo</span>: <span style=color:#2aa198>https</span>:<span style=color:#dc322f>//</span>github<span style=color:#719e07>.</span>com<span style=color:#719e07>/</span>nwops<span style=color:#719e07>/</span>puppet<span style=color:#719e07>-</span>debug
</code></pre></div><p>Puppet 4 also requires us to specify our dependencies in metadata before using any ruby based functions. So we will need
to add the debug module to the metadata&rsquo;s dependency list.</p>
<p>The module&rsquo;s metadata.json file should look something like this. For more info on metadata
<a href=https://docs.puppet.com/puppet/latest/modules_metadata.html target=_blank rel=noopener>click here</a></p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#2aa198>&#34;dependencies&#34;</span>: [
    {<span style=color:#268bd2>&#34;name&#34;</span>:<span style=color:#2aa198>&#34;puppetlabs-stdlib&#34;</span>,<span style=color:#268bd2>&#34;version_requirement&#34;</span>:<span style=color:#2aa198>&#34;&gt;= 4.11.0&#34;</span>},
    {<span style=color:#268bd2>&#34;name&#34;</span>:<span style=color:#2aa198>&#34;nwops-debug&#34;</span>,<span style=color:#268bd2>&#34;version_requirement&#34;</span>:<span style=color:#2aa198>&#34;&gt;= 0.1.1&#34;</span>}
  ]

</code></pre></div><h3 id=install-gems-and-fixtures>Install gems and fixtures</h3>
<ol>
<li>bundle install</li>
<li>bundle exec rake spec_prep</li>
</ol>
<h2 id=usage>Usage</h2>
<p>To break into our puppet code we need to first set a breakpoint. This is done by using the <code>debug::break()</code> function.
You can put this breakpoint anywhere in your puppet code. Once inside the debugger REPL, start poking variable values and run other debugger commands.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#719e07>class</span> testmod (
  $var1 <span style=color:#719e07>=</span> <span style=color:#2aa198>&#39;value&#39;</span>
) {
  debug<span style=color:#719e07>::</span><span style=color:#719e07>break</span>()
  file{<span style=color:#2aa198>&#34;/tmp/${var1}&#34;</span>:
    <span style=color:#719e07>ensure</span> <span style=color:#719e07>=&gt;</span> present
  }

}
</code></pre></div><p>Now in order to break into the puppet code you need to have puppet evaulate the code. This can be done in multiple ways.
The easiest is to use rspec-puppet, but you could also use <code>puppet debugger</code> or even <code>puppet apply</code> commands.</p>
<p>In the example below we just need to create a simple unit test and then run <code>bundle exec rake spec</code></p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>
it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#34;/tmp/value&#34;</span>)
        <span style=color:#719e07>.</span>with({
          <span style=color:#2aa198>&#34;ensure&#34;</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#34;present&#34;</span>
        })
<span style=color:#719e07>end</span>

</code></pre></div><p><img src=../../images/debug_rspec.gif alt="Debug using rspec"></p>
<p>As I mentioned above you can also use the puppet debugger directly and playback puppet code.
ie. <code>puppet debugger --play examples/debug.pp</code></p>
<p>
<a href=../../images/debug_directly.gif>Debug using puppet debugger command</a></p>
<p>When using puppet apply, just remember you either need to include the class like <code>include testmod</code> from within the debugger or puppet code.
Just remember when using with puppet apply puppet will actually make changes so be very careful.
This is why the <code>puppet debugger</code> command exist since it does not make changes.</p>
<div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>
root@f6e624d48fe2<span style=color:#2aa198>:~</span><span style=color:#dc322f>/testmod# puppet apply manifests/ini</span>t<span style=color:#719e07>.</span>pp
<span style=color:#cb4b16>Ruby</span> <span style=color:#2aa198>Version</span>: <span style=color:#2aa198>2</span><span style=color:#719e07>.</span><span style=color:#2aa198>2</span><span style=color:#719e07>.</span><span style=color:#2aa198>7</span>
<span style=color:#cb4b16>Puppet</span> <span style=color:#2aa198>Version</span>: <span style=color:#2aa198>4</span><span style=color:#719e07>.</span><span style=color:#2aa198>10</span><span style=color:#719e07>.</span><span style=color:#2aa198>0</span>
<span style=color:#cb4b16>Puppet</span> <span style=color:#cb4b16>Debugger</span> <span style=color:#2aa198>Version</span>: <span style=color:#2aa198>0</span><span style=color:#719e07>.</span><span style=color:#2aa198>6</span><span style=color:#719e07>.</span><span style=color:#2aa198>1</span>
<span style=color:#cb4b16>Created</span> <span style=color:#2aa198>by</span>: <span style=color:#cb4b16>NWOps</span> <span style=color:#719e07>&lt;</span>corey@nwops<span style=color:#719e07>.</span>io<span style=color:#719e07>&gt;</span>
<span style=color:#cb4b16>Type</span> <span style=color:#2aa198>&#34;exit&#34;</span>, <span style=color:#2aa198>&#34;functions&#34;</span>, <span style=color:#2aa198>&#34;vars&#34;</span>, <span style=color:#2aa198>&#34;krt&#34;</span>, <span style=color:#2aa198>&#34;whereami&#34;</span>, <span style=color:#2aa198>&#34;facts&#34;</span>, <span style=color:#2aa198>&#34;resources&#34;</span>, <span style=color:#2aa198>&#34;classes&#34;</span>,
     <span style=color:#2aa198>&#34;play&#34;</span>, <span style=color:#2aa198>&#34;classification&#34;</span>, <span style=color:#2aa198>&#34;types&#34;</span>, <span style=color:#2aa198>&#34;datatypes&#34;</span>, <span style=color:#2aa198>&#34;benchmark&#34;</span>,
     <span style=color:#2aa198>&#34;reset&#34;</span>, <span style=color:#719e07>or</span> <span style=color:#2aa198>&#34;help&#34;</span> <span style=color:#719e07>for</span> more information<span style=color:#719e07>.</span>

<span style=color:#cb4b16>From</span> <span style=color:#2aa198>file</span>: init<span style=color:#719e07>.</span>pp
          <span style=color:#2aa198>1</span>: <span style=color:#719e07>class</span> testmod (
          <span style=color:#2aa198>2</span>:   $var1 <span style=color:#719e07>=</span> <span style=color:#2aa198>&#39;value&#39;</span>
          <span style=color:#2aa198>3</span>:
          <span style=color:#2aa198>4</span>:
          <span style=color:#2aa198>5</span>: ) {
      <span style=color:#719e07>=&gt;</span>  <span style=color:#2aa198>6</span>:   debug<span style=color:#719e07>::</span><span style=color:#719e07>break</span>()
          <span style=color:#2aa198>7</span>:   file{<span style=color:#2aa198>&#34;/tmp/${var1}&#34;</span>:
          <span style=color:#2aa198>8</span>:     <span style=color:#719e07>ensure</span> <span style=color:#719e07>=&gt;</span> present
          <span style=color:#2aa198>9</span>:   }
         <span style=color:#2aa198>10</span>:
         <span style=color:#2aa198>11</span>: }
<span style=color:#2aa198>1</span><span style=color:#2aa198>:&gt;&gt;</span> <span style=color:#b58900>exit</span>
<span style=color:#2aa198>Notice</span>: <span style=color:#cb4b16>Compiled</span> catalog <span style=color:#719e07>for</span> f6e624d48fe2 <span style=color:#719e07>in</span> environment production <span style=color:#719e07>in</span> <span style=color:#2aa198>700</span><span style=color:#719e07>.</span><span style=color:#2aa198>28</span> seconds
<span style=color:#2aa198>Notice</span>: <span style=color:#dc322f>/Stage[main]/</span><span style=color:#cb4b16>Testmod</span><span style=color:#719e07>/</span><span style=color:#cb4b16>File</span><span style=color:#719e07>[</span><span style=color:#dc322f>/tmp/</span>value<span style=color:#719e07>]/</span><span style=color:#719e07>ensure</span>: created
<span style=color:#2aa198>Notice</span>: <span style=color:#cb4b16>Applied</span> catalog <span style=color:#719e07>in</span> <span style=color:#2aa198>0</span><span style=color:#719e07>.</span><span style=color:#2aa198>03</span> seconds

</code></pre></div><p>I hope these examples have given you an overview of all the different ways to invoke the puppet debugger and utilization of the <code>debug::break()</code>
function. You should now be equipped to start poking fun at puppet.</p>
<p>Stay tuned next time while I show how to debug with different facter sets using facterdb and the
<a href=https://github.com/nwops/puppet-debugger target=_blank rel=noopener>puppet-debugger</a>.</p>
</div>
<footer>
<p class=meta>
<span class="byline author vcard">Posted by <span class=fn>Corey Osman</span></span>
<time>Apr 25, 2017</time>
</span>
</p>
<p class=meta>
<a class="basic-alignment left" href=../../blog/2017-04-24-benchmarking-your-puppet-code/ title="Benchmarking Your Puppet Code">Benchmarking Your Puppet Code</a>
<a class="basic-alignment right" href=../../blog/2017-06-01-put-some-data-in-your-module/ title="Put some data in your module">Put some data in your module</a>
</p>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//logicalthoughtsexposed.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</footer>
</article>
</div>
<aside class="sidebar thirds">
<section class="first odd">
<p>
</p>
</section>
<ul class=sidebar-nav>
<li class=sidebar-nav-item>
<a target=_blank rel="noopener noreferrer" href=https://github.com/nwops/ title=https://github.com/nwops/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cosman2001 title=https://twitter.com/cosman2001><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/logicmindscorp/ title=https://www.linkedin.com/in/logicmindscorp/><i class="fa fa-linkedin fa-3x"></i></a>
</li>
</ul>
<section class=odd>
<li>
<a href=../../categories/ title=Categories>Categories</a>
</li>
<li>
<a href=../../tags/ title=Tags>Tags</a>
</li>
</section>
<section class=even>
<h1>Recent Posts</h1>
<ul id=recent_posts>
<li class=post>
<a href=../../blog/2022-02-22-trunk-based-development-for-your-control-repo/>Trunk based development for your control repo</a>
</li>
<li class=post>
<a href=../../blog/2021-04-14-decouple-your-control-repo-branches/>Decouple Your Control Repo Branches</a>
</li>
<li class=post>
<a href=../../blog/2021-02-15-no-code-is-the-best-code/>No Code Is the Best Code</a>
</li>
<li class=post>
<a href=../../blog/2021-02-14-getting-real-with-the-ral/>Getting real with the RAL</a>
</li>
<li class=post>
<a href=../../blog/2019-04-02-adding-puppet-debugger-and-other-gems-when-using-pdk/>Adding Puppet Debugger and other gems when using PDK</a>
</li>
<li class=post>
<a href=../../blog/2018-09-25-alternative-facts/>Alternative Facts</a>
</li>
<li class=post>
<a href=../../blog/2018-09-25-debugging-and-inspecting-hiera-lookups/>Debugging and Inspecting hiera lookups</a>
</li>
<li class=post>
<a href=../../blog/2017-10-12-retrospec-the-task-generator/>Retrospec - the task generator</a>
</li>
<li class=post>
<a href=../../blog/2017-06-01-put-some-data-in-your-module/>Put some data in your module</a>
</li>
</ul>
</section>
</aside>
</div>
</div>
<footer role=contentinfo>
<p>Copyright &copy; 2022 Corey Osman - <a href=../../license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.
</p>
</footer>
</body>
</html>