<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=../../css/fonts.css rel=stylesheet type=text/css><title>Getting real with the RAL</title><link rel=stylesheet href=../../css/hugo-octopress.css><link rel=stylesheet href=../../css/fork-awesome.min.css><link href=../../favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Corey Osman"><meta name=generator content="Hugo 0.82.0"></head><body><header role=banner><hgroup><h1><a href=../../>Logical thoughts exposed</a></h1><h2>A journey through my life as a infrastructure developer</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigateâ€¦</option></select></fieldset><ul class=main-navigation></ul><ul class=subscription><a href=../../index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Feb 14, 2021
- 3 minute read
- <a href=../../blog/2021-02-14-getting-real-with-the-ral/#disqus_thread>Comments</a>
- <a class=label href=../../categories/puppet/>puppet </a><a class=label href=../../categories/devops/>devops </a><a class=label href=../../categories/facts/>facts </a><a class=label href=../../categories/ral/>ral</a></p><h1 class=entry-title><a href=../../blog/2021-02-14-getting-real-with-the-ral/>Getting real with the RAL</a></h1></header><div class=entry-content><p>A client of mine recently had a need to discover that state of a particular package from inside a fact. Ironically, someone else in the puppet-community had a similar need and was asking questions about this. So I thought it
would be a good idea to blog about how to query the system agnostically without shelling out in a fact.</p><p>The original solution for many of us was to create a fact like the following:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>
<span style=color:#586e75># BTW, if you don&#39;t use `Facter::Core::Execution.execute` to run exec commands</span>
<span style=color:#586e75># start using this ruby call.  It provides many more enhancements like newline </span>
<span style=color:#586e75># removal, timeouts and default values. </span>

<span style=color:#586e75># lib/facter/is_ntp_installed.rb</span>
<span style=color:#cb4b16>Facter</span><span style=color:#719e07>.</span>add(<span style=color:#2aa198>:is_ntp_installed</span>) <span style=color:#719e07>do</span>
  confine <span style=color:#2aa198>:osfamily</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;RedHat&#39;</span>
  setcode <span style=color:#719e07>do</span>
     <span style=color:#586e75># if the returned value is empty, ntp is not installed</span>
     <span style=color:#719e07>!</span> <span style=color:#cb4b16>Facter</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Execution</span><span style=color:#719e07>.</span>execute(<span style=color:#2aa198>&#39;rpm -qa ntp&#39;</span>)<span style=color:#719e07>.</span>empty?
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>

</code></pre></div><p>However, this leads us to a fact that only works on systems with rpm. If this is all you want then no need to implement anything else. Just remember to confine the fact to only RedHat based systems.</p><p>But if this module is expected to work on many operating systems you need an abstraction layer on top to find if ntp is present. Otherwise you end up writing a huge case statement that queries the system differently for each OS.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#586e75># lib/facter/is_ntp_installed.rb</span>
<span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;puppet&#39;</span>
<span style=color:#cb4b16>Facter</span><span style=color:#719e07>.</span>add(<span style=color:#2aa198>:is_ntp_installed</span>) <span style=color:#719e07>do</span>
	setcode <span style=color:#719e07>do</span>
		<span style=color:#719e07>case</span> $osfamily
		<span style=color:#719e07>when</span> <span style=color:#2aa198>&#39;redhat&#39;</span>
		  <span style=color:#719e07>!</span> <span style=color:#cb4b16>Facter</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Execution</span><span style=color:#719e07>.</span>execute(<span style=color:#2aa198>&#39;rpm -qa ntp&#39;</span>)<span style=color:#719e07>.</span>empty?
		<span style=color:#719e07>when</span> <span style=color:#2aa198>&#39;debian&#39;</span>
		  <span style=color:#719e07>!</span> <span style=color:#cb4b16>Facter</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Core</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Execution</span><span style=color:#719e07>.</span>execute(<span style=color:#2aa198>&#39;dpkg -l ntp&#39;</span>)<span style=color:#719e07>.</span>empty?
		<span style=color:#719e07>else</span>
			<span style=color:#719e07>nil</span>
		<span style=color:#719e07>end</span>
	<span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>
</code></pre></div><h3 id=the-puppet-ral-resource-abstraction-layer>The puppet RAL (Resource abstraction layer).</h3><p>The RAL determines how to discover the ntp package using the type and provider mechanisms built into puppet. We utilize puppet to create a fact to use in puppet code. Genius, right? So the RAL will query the system for the name of the type we are interested in with very little work.</p><p>When we look at the output using puppet resource we see we have a ruby object with
useful data. Note that the name package in <code>package/ntp</code> is the puppet type and ntp is the name of the resource.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>package_resource <span style=color:#719e07>=</span> <span style=color:#cb4b16>Puppet</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Resource</span><span style=color:#719e07>.</span>indirection<span style=color:#719e07>.</span>find(<span style=color:#2aa198>&#39;package/ntp&#39;</span>)
<span style=color:#586e75># Output of using the RAL</span>
<span style=color:#719e07>=&gt;</span> <span style=color:#cb4b16>Package</span><span style=color:#719e07>[</span>ntp<span style=color:#719e07>]</span>
	{
		<span style=color:#2aa198>:name</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;ntp&#34;</span>, 
		<span style=color:#2aa198>:ensure</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>:purged</span>, 
		<span style=color:#2aa198>:provider</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>:yum</span>, 
		<span style=color:#2aa198>:audit</span><span style=color:#719e07>=&gt;[</span><span style=color:#2aa198>:ensure</span>, <span style=color:#2aa198>:package_settings</span><span style=color:#719e07>]</span>, 
		<span style=color:#2aa198>:configfiles</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>:keep</span>, 
		<span style=color:#2aa198>:allow_virtual</span><span style=color:#719e07>=&gt;</span><span style=color:#719e07>true</span>, 
		<span style=color:#2aa198>:reinstall_on_refresh</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>:false</span>, 
		<span style=color:#2aa198>:loglevel</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>:notice</span>
	}

</code></pre></div><p>When used inside facter it looks like:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#586e75># lib/facter/is_ntp_installed.rb</span>
<span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;puppet&#39;</span>
<span style=color:#cb4b16>Facter</span><span style=color:#719e07>.</span>add(<span style=color:#2aa198>:is_ntp_installed</span>) <span style=color:#719e07>do</span>
	setcode <span style=color:#719e07>do</span>
		package_resource <span style=color:#719e07>=</span> <span style=color:#cb4b16>Puppet</span><span style=color:#719e07>::</span><span style=color:#cb4b16>Resource</span><span style=color:#719e07>.</span>indirection<span style=color:#719e07>.</span>find(<span style=color:#2aa198>&#39;package/ntp&#39;</span>)
	  package_resource<span style=color:#719e07>[</span><span style=color:#2aa198>:ensure</span><span style=color:#719e07>]</span> <span style=color:#719e07>!=</span> <span style=color:#2aa198>:purged</span> <span style=color:#719e07>||</span> package_resource<span style=color:#719e07>[</span><span style=color:#2aa198>:absent</span><span style=color:#719e07>]</span>
	<span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>
</code></pre></div><p>This fact will call out to puppet and ask what packages have the ntp as the name. What you get back is a package resource with a few attributes that can be further filtered. You might have noticed that we never shelled out or specified rpm/deb/yum or any package provide to determine if ntp is installed.</p><p>You can use any native puppet type that is able to list out the resource. Some examples:</p><ul><li>user</li><li>group</li><li>service</li><li>package</li><li>firewall</li><li>many more native and third party</li></ul><p>Examples:</p><ul><li><code>user_resource = Puppet::Resource.indirection.find('user/apache')</code></li><li><code>firewall_resources = Puppet::Resource.indirection.find('firewall')</code></li></ul><p>So next time you need to test for a package try the Puppet RAL instead to make your code OS agnostic.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Corey Osman</span></span>
<time>Feb 14, 2021</time></span></p><p class=meta><a class="basic-alignment left" href=../../blog/2019-04-02-adding-puppet-debugger-and-other-gems-when-using-pdk/ title="Adding Puppet Debugger and other gems when using PDK">Adding Puppet Debugger and other gems when using PDK</a>
<a class="basic-alignment right" href=../../blog/2021-02-15-no-code-is-the-best-code/ title="No Code Is the Best Code">No Code Is the Best Code</a></p><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//logicalthoughtsexposed.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nwops/ title=https://github.com/nwops/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cosman2001 title=https://twitter.com/cosman2001><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/logicmindscorp/ title=https://www.linkedin.com/in/logicmindscorp/><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><li><a href=../../categories/ title=Categories>Categories</a></li><li><a href=../../tags/ title=Tags>Tags</a></li></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=../../blog/2021-03-13-decouple-your-control-repo-branches/>Decouple Your Control Repo Branches</a></li><li class=post><a href=../../blog/2021-02-15-no-code-is-the-best-code/>No Code Is the Best Code</a></li><li class=post><a href=../../blog/2021-02-14-getting-real-with-the-ral/>Getting real with the RAL</a></li><li class=post><a href=../../blog/2019-04-02-adding-puppet-debugger-and-other-gems-when-using-pdk/>Adding Puppet Debugger and other gems when using PDK</a></li><li class=post><a href=../../blog/2018-09-25-alternative-facts/>Alternative Facts</a></li><li class=post><a href=../../blog/2018-09-25-debugging-and-inspecting-hiera-lookups/>Debugging and Inspecting hiera lookups</a></li><li class=post><a href=../../blog/2017-10-12-retrospec-the-task-generator/>Retrospec - the task generator</a></li><li class=post><a href=../../blog/2017-06-01-put-some-data-in-your-module/>Put some data in your module</a></li><li class=post><a href=../../blog/2017-04-25-break-into-your-puppet-code/>Break into your puppet code</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2021 Corey Osman - <a href=../../license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>