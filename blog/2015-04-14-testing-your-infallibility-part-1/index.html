<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,minimum-scale=1,maximum-scale=1"><link href=../../css/fonts.css rel=stylesheet type=text/css><title>Testing Your infallibility - Part 1</title><link rel=stylesheet href=../../css/hugo-octopress.css><link rel=stylesheet href=../../css/fork-awesome.min.css><link href=../../favicon.png rel=icon><meta name=description content><meta name=keywords content><meta name=author content="Corey Osman"><meta name=generator content="Hugo 0.82.0"></head><body><header role=banner><hgroup><h1><a href=../../>Logical thoughts exposed</a></h1><h2>A journey through my life as a infrastructure developer</h2></hgroup></header><nav role=navigation><fieldset class=mobile-nav><select onchange="location=this.value"><option value>Navigate…</option></select></fieldset><ul class=main-navigation></ul><ul class=subscription><a href=../../index.xml target=_blank type=application/rss+xml title=RSS rel="noopener noreferrer"><i class="fa fa-rss-square fa-lg"></i></a></ul><form action=https://www.google.com/search method=get target=_blank rel="noopener noreferrer"><fieldset role=search><input class=search type=text name=q results=0 placeholder=Search>
<input type=hidden name=q value=site:/></fieldset></form></nav><div id=main><div id=content><div><article class=hentry role=article><header><p class=meta>Apr 14, 2015
- 12 minute read
- <a href=../../blog/2015-04-14-testing-your-infallibility-part-1/#disqus_thread>Comments</a>
- <a class=label href=../../categories/puppet/>puppet </a><a class=label href=../../categories/chef/>chef </a><a class=label href=../../categories/rspec/>rspec </a><a class=label href=../../categories/unit-testing/>unit testing </a><a class=label href=../../categories/testing/>testing</a></p><h1 class=entry-title>Testing Your infallibility - Part 1</h1></header><div class=entry-content><p>Audience: System Admin, Self taught coder, Computer Scientist</p><p>Summary: How to leverage puppet-retrospec to generate your puppet unit test suite</p><p>How many of you remember when the spell checker first came out? It had such a huge impact in everyones life because
instantly everyone who used the spell checker appeared as if they had won the international spelling bee. How long did
it take you to switch from looking up every single word in a paper dictionary to simply right clicking on a word?
Assuming you grew up in the 90’s, we had to use books to spell check, crazy isn’t it.
Spell checker turned horrible spellers into artisan letter assemblers overnight. With that said, I consider the spell
checker to be the first form of unit testing because the spell checker tested every word of your summer vacation essay
against a simple algorithm to ensure the word passed a basic spelling test.</p><p>So what does spell checking have to do with configuration management tools like Chef and Puppet? Basically, after you
learn some basic CF (Configuration Management) programming you will need to start testing your own code, just like the
spell checker. If your new to development which includes anybody using configuration management, unit testing your CF
code brings a spotlight to bugs without having to pay much attention. This is especially important because a
sysadmin’s workday is bombarded with distractions, especially from your trusty feline sidekick. So lets move
forward and review some basic automated testing principles.</p><p>When it comes to testing there are two types one must test. You might have seen these before but these types
are unit and acceptance/integration testing.</p><h2 id=unit-testing>Unit testing</h2><p>The unit test performs a very simple test to ensure that you do not have syntax errors and your conditional logic works
against a set of supplied assumptions. Does your conditional statements work as intended? Do your variables
interpolate correctly? Do the functions you use, perform the magic you expected? These are the things you should be
asking yourself when building unit tests.</p><h2 id=writing-your-first-unit-test>Writing your first unit test</h2><p>With regards to configuration management code we will first test against compile time bugs because that is where the bulk of
your mistakes will be caught and its also the fastest.</p><p>Part of the problem with new developers and lack of test code is the amount of time taken away from writing the “real” code.
There are plenty of articles on how to write test code, but its often difficult to find something that caters to the
absolute beginner and just getting the code setup to run tests is often too much. So questions like, whats a helper?,
whats rspec?, mocking, mocha, shoulda, doubles, fixtures, unit test, integration test, a/b test? The problem is that you
already don’t know what your doing and to make matters worse, now you have to learn new terminology to test the code
that you barely know how to write. The mountain of knowledge needed to run a basic test serves as a barrier to becoming
a better programmer and is often what separates a junior from a senior level programmer. Testing should be just as easy
as writing the code itself. While I cannot change the fact that good testing practices is a skill in itself. I can at
least automate some basic testing patterns and remove the immediate barrier to becoming a better configuration
management programmer.</p><p>With this in mind I would like to introduce
<a href=https://github.com/logicminds/puppet-retrospec target=_blank rel=noopener>Retrospec</a>. Retrospec is a
tool that will generate puppet rspec test code based on the code inside the manifests directory. Its sole purpose is to
get your module setup with automated testing, stat! Additionally, Retrospec will actually write some basic test code
for you. Yes, you heard me right, it will write tests for you, even while you sip beer. While the generated tests are only
basic checks it lays the groundwork for you to create even more advanced test cases and increase your BeerOps time. So
lets get started.</p><p>The first thing you need to do is install retrospec <code>gem install puppet-retrospec</code></p><p>We will use a puppet module I wrote for non-root environments as an example. Go ahead and clone this repo so you
can follow along.</p><pre><code>  git clone https://github.com/logicminds/puppet-nonrootlib
  cd puppet-nonrootlib
</code></pre><p>Now we just need to do some house cleaning to show how retrospec generates files easily. Obviously, you won&rsquo;t do this
in your own module, unless you really want to.</p><pre><code>  rm -rf spec/  # helps show magic
  rm -f Gemfile Rakefile .fixtures.yml
</code></pre><p>You can run retrospec -h by itself to see what options you have.</p><pre><code>$ puppet retrospec -h
Options:
        --module-path, -m &lt;s&gt;:   The path (relative or absolute) to the module
                                 directory (Defaults to current directory)
       --template-dir, -t &lt;s&gt;:   Path to templates directory (only for
                                 overriding Retrospec templates)
  --enable-user-templates, -e:   Use Retrospec templates from
                                 /Users/cosman/.puppet_retrospec_templates
    --enable-beaker-tests, -n:   Enable the creation of beaker tests
   --enable-future-parser, -a:   Enables the future parser only during
                                 validation
                   --help, -h:   Show this message

</code></pre><p>Now that we have a module without tests we can use Retrospec to retrofit the module with some basic tests.
Many of these basic files are needed for the puppetlabs_spec_helper and rspec-puppet.</p><p><em>Note:</em> If you have set your bundle path to be something other than GEM_HOME you will need to install retrospec in that path.
<code>bundle exec gem install puppet-retrospec</code>, otherwise you will get an error.</p><pre><code>  $ puppet retrospec     # no need for -m if in the module directory
  + /private/tmp/puppet-nonrootlib/Gemfile
  + /private/tmp/puppet-nonrootlib/Rakefile
  + /private/tmp/puppet-nonrootlib/spec/
  + /private/tmp/puppet-nonrootlib/spec/shared_contexts.rb
  + /private/tmp/puppet-nonrootlib/spec/spec_helper.rb
  + /private/tmp/puppet-nonrootlib/.fixtures.yml
 !! /private/tmp/puppet-nonrootlib/.gitignore already exists and differs from template
 !! /private/tmp/puppet-nonrootlib/.travis.yml already exists and differs from template
  + /private/tmp/puppet-nonrootlib/spec/classes/
  + /private/tmp/puppet-nonrootlib/spec/classes/nonrootlib_spec.rb
  + /private/tmp/puppet-nonrootlib/spec/classes/rpm_spec.rb
  + /private/tmp/puppet-nonrootlib/spec/defines/
  + /private/tmp/puppet-nonrootlib/spec/defines/init_script_spec.rb
  + /private/tmp/puppet-nonrootlib/spec/defines/sysconfig_spec.rb
</code></pre><p>Bam! Wasn&rsquo;t that easy?</p><p>Now Retrospec isn&rsquo;t perfect but it did save us several hours of BeerOps time for us by generating all these files. You
should see something similar like below when you run <code>cat spec/classes/nonrootlib_spec.rb</code>. This gives us a easy place
to start. Keep following and I&rsquo;ll show you some basic testing patterns to fix some of this generated code. Retrospec
only generates files that you do not already have as noted by the <code>!!</code> and <code>+</code> symbols.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;spec_helper&#39;</span>
<span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;shared_contexts&#39;</span>

describe <span style=color:#2aa198>&#39;nonrootlib&#39;</span> <span style=color:#719e07>do</span>
  <span style=color:#586e75># by default the hiera integration uses hiera data from the shared_contexts.rb file</span>
  <span style=color:#586e75># but basically to mock hiera you first need to add a key/value pair</span>
  <span style=color:#586e75># to the specific context in the spec/shared_contexts.rb file</span>
  <span style=color:#586e75># Note: you can only use a single hiera context per describe/context block</span>
  <span style=color:#586e75># rspec-puppet does not allow you to swap out hiera data on a per test block</span>
  <span style=color:#586e75>#include_context :hiera</span>


  <span style=color:#586e75># below is the facts hash that gives you the ability to mock</span>
  <span style=color:#586e75># facts on a per describe/context block.  If you use a fact in your</span>
  <span style=color:#586e75># manifest you should mock the facts below.</span>
  let(<span style=color:#2aa198>:facts</span>) <span style=color:#719e07>do</span>
    { }
  <span style=color:#719e07>end</span>
  <span style=color:#586e75># below is a list of the resource parameters that you can override.</span>
  <span style=color:#586e75># By default all non-required parameters are commented out,</span>
  <span style=color:#586e75># while all required parameters will require you to add a value</span>
  let(<span style=color:#2aa198>:params</span>) <span style=color:#719e07>do</span>
    {
      <span style=color:#586e75>#:install_core =&gt; $home_dir,</span>
      <span style=color:#586e75>#:owner =&gt; $id,</span>
      <span style=color:#586e75>#:group =&gt; $id,</span>
      <span style=color:#586e75>#:etc_dir =&gt; $home_dir/etc,</span>
      <span style=color:#586e75>#:bin_dir =&gt; $home_dir/bin,</span>
      <span style=color:#586e75>#:var_dir =&gt; $home_dir/var,</span>
      <span style=color:#586e75>#:usr_dir =&gt; $home_dir/usr,</span>
      <span style=color:#586e75>#:tmp_dir =&gt; $home_dir/tmp,</span>
      <span style=color:#586e75>#:initd_dir =&gt; $home_dir/etc/init.d,</span>
      <span style=color:#586e75>#:lib_dir =&gt; $home_dir/lib,</span>
      <span style=color:#586e75>#:sysconfig_dir =&gt; $home_dir/etc/sysconfig,</span>
      <span style=color:#586e75>#:run_dir =&gt; $home_dir/var/run,</span>
      <span style=color:#586e75>#:lock_dir =&gt; $home_dir/var/lock,</span>
      <span style=color:#586e75>#:subsys_dir =&gt; $home_dir/var/lock/subsys,</span>
      <span style=color:#586e75>#:log_dir =&gt; $home_dir/var/log,</span>
    }
  <span style=color:#719e07>end</span>
  <span style=color:#586e75># add these two lines in a single test block to enable puppet and hiera debug mode</span>
  <span style=color:#586e75># Puppet::Util::Log.level = :debug</span>
  <span style=color:#586e75># Puppet::Util::Log.newdestination(:console)</span>
  it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#39;[$install_core, $etc_dir, $bin_dir, $var_dir, $usr_dir, $tmp_dir, $initd_dir, $lib_dir, $sysconfig_dir, $run_dir, $lock_dir, $subsys_dir, $log_dir]&#39;</span>)<span style=color:#719e07>.</span>
             with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;directory&#34;</span>})
  <span style=color:#719e07>end</span>
  it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#39;$home_dir/bin/service&#39;</span>)<span style=color:#719e07>.</span>
             with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;present&#34;</span>,
                   <span style=color:#2aa198>&#34;content&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;template(nonrootlib/service.erb)&#34;</span>,
                   <span style=color:#2aa198>&#34;require&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;File[$bin_dir]&#34;</span>})
  <span style=color:#719e07>end</span>
  it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#39;$home_dir/.bash_profile&#39;</span>)<span style=color:#719e07>.</span>
             with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;present&#34;</span>,
                   <span style=color:#2aa198>&#34;content&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;template(nonrootlib/.bash_profile.erb)&#34;</span>,
                   <span style=color:#2aa198>&#34;require&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;File[$install_core]&#34;</span>})
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>
</code></pre></div><h3 id=test-prep>Test Prep</h3><p>Once you retrospec your module many tests are generated but need to be prepped for testing. Note the tests will fail
until you refactor the test code. Since testing puppet code relies heavily on other gems we need to use bundler
to download all these dependencies.</p><ol start=0><li><code>cd puppet-nonrootlib</code> # if not already in the directory</li><li><code>gem install bundler</code> # unless bundler is already installed</li><li><code>bundle install</code> # installs all the gems necessary for puppet unit testing ( You should be in the module directory)</li><li><code>bundle exec rake spec_prep</code> # sets up fixtures, not necessary if using rake spec</li><li><code>bundle exec rspec spec/classes/nonrootlib_spec.rb</code> # run your test against a single test file</li></ol><p>Normally you would run <code>bundle exec rake spec</code> but I wanted to just run a single test file so I used rspec directly.</p><p>Lets go ahead and open the spec/classes/nonrootlib_spec.rb file and
<a href=http://en.wikipedia.org/wiki/Code_refactoring target=_blank rel=noopener>refactor</a> the test code, because out of the box, these tests will fail.</p><h3 id=basic-mocking>Basic mocking</h3><p>Below is an example of how you
<a href=http://en.wikipedia.org/wiki/Mock_object target=_blank rel=noopener>mock</a> facts in a rspec-puppet testing
environment. I refactored spec/classes/nonrootlib_spec.rb to work by specifying the facts to mock like home_dir and id.
Note, these are just mocks so directories and users don&rsquo;t actually have to exist. I only need to mock the facts that are
used in my manfiest code. Go ahead and update your spec/classes/nonrootlib_spec.rb file to match the facts block below.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  let(<span style=color:#2aa198>:facts</span>) <span style=color:#719e07>do</span>
    { <span style=color:#2aa198>:home_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1&#39;</span>, <span style=color:#2aa198>:id</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;user1&#39;</span> }
  <span style=color:#719e07>end</span>
</code></pre></div><p><em>Note:</em>
You can only mock hiera values, facts, params, and functions with rspec-puppet. This is all you really need to influence
conditional logic in your code as your will be testing against the catalog. I am only covering facts and params in this
article since the other items are considered an advanced topic. Plus your attention span can&rsquo;t handle much more anyways.</p><h3 id=parameter-mocking>Parameter Mocking</h3><p>Below is a real example of how you can mock parameters to incluence your conditional logic. It follows the same syntax
as mocking facts. You may have noticed that retrospec comments out any parameters with default values. However,
I specified each parameter value statically as I consider specifying the parameter values better for long
term test maintainability. If a future developer changes the default parameter values in your manifest code some of
these test will break, so its good practice to set them in stone here. But your not required to do this which is why
they are commented out in the initial test generation. This is where you can mock parameter values and test against
different scenarios. Its worth noting that without Retrospec you would had to specify every parameter by hand.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>let(<span style=color:#2aa198>:params</span>) <span style=color:#719e07>do</span>
    {
      <span style=color:#2aa198>:install_core</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1&#39;</span>,
      <span style=color:#2aa198>:owner</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;user1&#39;</span>,
      <span style=color:#2aa198>:group</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;user1&#39;</span>,
      <span style=color:#2aa198>:etc_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/etc&#39;</span>,
      <span style=color:#2aa198>:bin_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/bin&#39;</span>,
      <span style=color:#2aa198>:var_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var&#39;</span>,
      <span style=color:#2aa198>:usr_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/usr&#39;</span>,
      <span style=color:#2aa198>:tmp_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/tmp&#39;</span>,
      <span style=color:#2aa198>:initd_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/etc/init.d&#39;</span>,
      <span style=color:#2aa198>:lib_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/lib&#39;</span>,
      <span style=color:#2aa198>:sysconfig_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/etc/sysconfig&#39;</span>,
      <span style=color:#2aa198>:run_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/run&#39;</span>,
      <span style=color:#2aa198>:lock_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/lock&#39;</span>,
      <span style=color:#2aa198>:subsys_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/lock/subsys&#39;</span>,
      <span style=color:#2aa198>:log_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/log&#39;</span>,
    }
<span style=color:#719e07>end</span>
</code></pre></div><h3 id=basic-tests>Basic Tests</h3><p>Since the manifest code creates a bunch of directories you can speed up your test creation by using the ruby
each iterator and iterate around the resources you are creating by defining an array. This only works because all the
resources have the same attributes with the exception of the name. Alternatively, you could statically define each test
case as well, but call me lazy. Rspec-puppet which is the testing library required for testing puppet code will
query the catalog that puppet generated during the testing process.</p><p>When you write a test it should mentally read, &ldquo;The manifest named nonrootlib when compiled into a catalog is expected to contain
the file resource XX with ensure set to directory.&rdquo;</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby> dirs <span style=color:#719e07>=</span> <span style=color:#719e07>[</span><span style=color:#2aa198>&#39;/home/user1&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/etc&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/bin&#39;</span>,<span style=color:#2aa198>&#39;/home/user1/usr&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/tmp&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/etc/init.d&#39;</span>,
    <span style=color:#2aa198>&#39;/home/user1/lib&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/etc/sysconfig&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/var/run&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/var/lock&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/var/lock/subsys&#39;</span>,
    <span style=color:#2aa198>&#39;/home/user1/var/log&#39;</span>
    <span style=color:#719e07>]</span>
 dirs<span style=color:#719e07>.</span>each <span style=color:#719e07>do</span> <span style=color:#719e07>|</span> dir<span style=color:#719e07>|</span>
     it <span style=color:#719e07>do</span>
       is_expected<span style=color:#719e07>.</span>to contain_file(dir)<span style=color:#719e07>.</span>with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;directory&#34;</span>})
     <span style=color:#719e07>end</span>
 <span style=color:#719e07>end</span>
</code></pre></div><p>I have also gone ahead and removed the content line from the service and bash_profile resource because I will discuss
verifying content in a future article. So go ahead and replace the contents below in your own
spec/classes/nonrootlib_spec.rb file just like below.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby>  it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#39;/home/user1/bin/service&#39;</span>)<span style=color:#719e07>.</span>
             with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;present&#34;</span>,
                   <span style=color:#2aa198>&#34;require&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;File[/home/user1/bin]&#34;</span>})
  <span style=color:#719e07>end</span>
  it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#39;/home/user1/.bash_profile&#39;</span>)<span style=color:#719e07>.</span>
             with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;present&#34;</span>,
                   <span style=color:#2aa198>&#34;require&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;File[/home/user1]&#34;</span>})
  <span style=color:#719e07>end</span>

</code></pre></div><p>The finished test code after refactor.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;spec_helper&#39;</span>
<span style=color:#b58900>require</span> <span style=color:#2aa198>&#39;shared_contexts&#39;</span>

describe <span style=color:#2aa198>&#39;nonrootlib&#39;</span> <span style=color:#719e07>do</span>

  <span style=color:#586e75># below is the facts hash that gives you the ability to mock</span>
  <span style=color:#586e75># facts on a per describe/context block.  If you use a fact in your</span>
  <span style=color:#586e75># manifest you should mock the facts below.</span>
  let(<span style=color:#2aa198>:facts</span>) <span style=color:#719e07>do</span>
    { <span style=color:#2aa198>:home_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1&#39;</span>, <span style=color:#2aa198>:id</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;user1&#39;</span> }
  <span style=color:#719e07>end</span>
  <span style=color:#586e75># below is a list of the resource parameters that you can override.</span>
  <span style=color:#586e75># By default all non-required parameters are commented out,</span>
  <span style=color:#586e75># while all required parameters will require you to add a value</span>
  let(<span style=color:#2aa198>:params</span>) <span style=color:#719e07>do</span>
    {
      <span style=color:#2aa198>:install_core</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1&#39;</span>,
      <span style=color:#2aa198>:owner</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;user1&#39;</span>,
      <span style=color:#2aa198>:group</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;user1&#39;</span>,
      <span style=color:#2aa198>:etc_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/etc&#39;</span>,
      <span style=color:#2aa198>:bin_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/bin&#39;</span>,
      <span style=color:#2aa198>:var_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var&#39;</span>,
      <span style=color:#2aa198>:usr_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/usr&#39;</span>,
      <span style=color:#2aa198>:tmp_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/tmp&#39;</span>,
      <span style=color:#2aa198>:initd_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/etc/init.d&#39;</span>,
      <span style=color:#2aa198>:lib_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/lib&#39;</span>,
      <span style=color:#2aa198>:sysconfig_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/etc/sysconfig&#39;</span>,
      <span style=color:#2aa198>:run_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/run&#39;</span>,
      <span style=color:#2aa198>:lock_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/lock&#39;</span>,
      <span style=color:#2aa198>:subsys_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/lock/subsys&#39;</span>,
      <span style=color:#2aa198>:log_dir</span> <span style=color:#719e07>=&gt;</span> <span style=color:#2aa198>&#39;/home/user1/var/log&#39;</span>,
    }
  <span style=color:#719e07>end</span>
  <span style=color:#586e75># add these two lines in a single test block to enable puppet and hiera debug mode</span>
  <span style=color:#586e75># Puppet::Util::Log.level = :debug</span>
  <span style=color:#586e75># Puppet::Util::Log.newdestination(:console)</span>
  dirs <span style=color:#719e07>=</span> <span style=color:#719e07>[</span><span style=color:#2aa198>&#39;/home/user1&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/etc&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/bin&#39;</span>,<span style=color:#2aa198>&#39;/home/user1/usr&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/tmp&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/etc/init.d&#39;</span>,
   <span style=color:#2aa198>&#39;/home/user1/lib&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/etc/sysconfig&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/var/run&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/var/lock&#39;</span>, <span style=color:#2aa198>&#39;/home/user1/var/lock/subsys&#39;</span>,
   <span style=color:#2aa198>&#39;/home/user1/var/log&#39;</span>
   <span style=color:#719e07>]</span>
  dirs<span style=color:#719e07>.</span>each <span style=color:#719e07>do</span> <span style=color:#719e07>|</span> dir<span style=color:#719e07>|</span>
    it <span style=color:#719e07>do</span>
      is_expected<span style=color:#719e07>.</span>to contain_file(dir)<span style=color:#719e07>.</span>with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;directory&#34;</span>})
    <span style=color:#719e07>end</span>
  <span style=color:#719e07>end</span>
  it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#39;/home/user1/bin/service&#39;</span>)<span style=color:#719e07>.</span>
             with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;present&#34;</span>,
                   <span style=color:#2aa198>&#34;require&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;File[/home/user1/bin]&#34;</span>})
  <span style=color:#719e07>end</span>
  it <span style=color:#719e07>do</span>
    is_expected<span style=color:#719e07>.</span>to contain_file(<span style=color:#2aa198>&#39;/home/user1/.bash_profile&#39;</span>)<span style=color:#719e07>.</span>
             with({<span style=color:#2aa198>&#34;ensure&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;present&#34;</span>,
                   <span style=color:#2aa198>&#34;require&#34;</span><span style=color:#719e07>=&gt;</span><span style=color:#2aa198>&#34;File[/home/user1]&#34;</span>})
  <span style=color:#719e07>end</span>
<span style=color:#719e07>end</span>
</code></pre></div><h3 id=working-example>Working Example</h3><p>At this point your ready to test and should see similar output (I have omitted some deprecation warnings)</p><pre><code>$ bundle exec rake spec_prep
$ bundle exec rspec spec/classes/nonrootlib_spec.rb


nonrootlib
  should contain File[/home/user1] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/etc] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/bin] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/usr] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/tmp] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/etc/init.d] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/lib] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/etc/sysconfig] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/var/run] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/var/lock] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/var/lock/subsys] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/var/log] with ensure =&gt; &quot;directory&quot;
  should contain File[/home/user1/bin/service] with ensure =&gt; &quot;present&quot; and require =&gt; &quot;File[/home/user1/bin]&quot;
  should contain File[/home/user1/.bash_profile] with ensure =&gt; &quot;present&quot; and require =&gt; &quot;File[/home/user1]&quot;

  Finished in 0.35775 seconds (files took 0.86506 seconds to load)
  14 examples, 0 failures
</code></pre><p>Now that you have created your first rspec-puppet test you should be able to start testing your infallibleness on your
own module and find out just how perfect your code is. With the help of Retrospec this should be pretty easy. But
remember unit testing is not just about testing your code, its about maintaining code integrity long after you have left.
Because many times when new folks are added to a team they make a ton of mistakes until they are familiar with the code
base. So its important to build a safety net for them with basic unit tests that allows them to test against a feature set
outlined in the test code.</p><p>There are many things that I did not discuss in this article that are very important but Retrospec automated these
things such as
<a href=https://github.com/puppetlabs/puppetlabs_spec_helper#using-fixtures target=_blank rel=noopener>.fixtures.yml</a>, spec_helper,
Rakefile, Gemfile and others. So stay tuned and I&rsquo;ll cover the these items in a later article.</p></div><footer><p class=meta><span class="byline author vcard">Posted by <span class=fn>Corey Osman</span></span>
<time>Apr 14, 2015</time></span></p><p class=meta><a class="basic-alignment left" href=../../blog/2015-04-10-remotely-controlling-your-server-with-ipmi/ title="Remotely Controlling Your Server With IPMI">Remotely Controlling Your Server With IPMI</a>
<a class="basic-alignment right" href=../../blog/2015-05-28-leveraging-docker-for-puppet-development/ title="Leveraging Docker for Puppet Development">Leveraging Docker for Puppet Development</a></p><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//logicalthoughtsexposed.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></footer></article></div><aside class="sidebar thirds"><section class="first odd"><p></p></section><ul class=sidebar-nav><li class=sidebar-nav-item><a target=_blank rel="noopener noreferrer" href=https://github.com/nwops/ title=https://github.com/nwops/><i class="fa fa-github fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://twitter.com/cosman2001 title=https://twitter.com/cosman2001><i class="fa fa-twitter fa-3x"></i></a>
<a target=_blank rel="noopener noreferrer" href=https://www.linkedin.com/in/logicmindscorp/ title=https://www.linkedin.com/in/logicmindscorp/><i class="fa fa-linkedin fa-3x"></i></a></li></ul><section class=odd><li><a href=../../categories/ title=Categories>Categories</a></li><li><a href=../../tags/ title=Tags>Tags</a></li></section><section class=even><h1>Recent Posts</h1><ul id=recent_posts><li class=post><a href=../../blog/2021-04-14-decouple-your-control-repo-branches/>Decouple Your Control Repo Branches</a></li><li class=post><a href=../../blog/2021-02-15-no-code-is-the-best-code/>No Code Is the Best Code</a></li><li class=post><a href=../../blog/2021-02-14-getting-real-with-the-ral/>Getting real with the RAL</a></li><li class=post><a href=../../blog/2019-04-02-adding-puppet-debugger-and-other-gems-when-using-pdk/>Adding Puppet Debugger and other gems when using PDK</a></li><li class=post><a href=../../blog/2018-09-25-alternative-facts/>Alternative Facts</a></li><li class=post><a href=../../blog/2018-09-25-debugging-and-inspecting-hiera-lookups/>Debugging and Inspecting hiera lookups</a></li><li class=post><a href=../../blog/2017-10-12-retrospec-the-task-generator/>Retrospec - the task generator</a></li><li class=post><a href=../../blog/2017-06-01-put-some-data-in-your-module/>Put some data in your module</a></li><li class=post><a href=../../blog/2017-04-25-break-into-your-puppet-code/>Break into your puppet code</a></li></ul></section></aside></div></div><footer role=contentinfo><p>Copyright &copy; 2021 Corey Osman - <a href=../../license/>License</a> -
<span class=credit>Powered by <a target=_blank href=https://gohugo.io rel="noopener noreferrer">Hugo</a> and <a target=_blank href=https://github.com/parsiya/hugo-octopress/ rel="noopener noreferrer">Hugo-Octopress</a> theme.</p></footer></body></html>